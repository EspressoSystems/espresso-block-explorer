import { DataStatistics } from '@/components/visual/histogram/histogram_base/DataStatistics';
import {
  dropIterable,
  filterIterable,
  mapIterable,
  zipWithIterable,
} from '@/functional/functional';

describe('statistics', () => {
  it('should compute statistics correctly', () => {
    const response = {
      explorer_summary: {
        latest_block: {
          hash: 'BLOCK~GUNsyaAvccldR1WCO-XunDAnwhtsJNayaC0kgp5SHinR',
          height: 1754270,
          time: '2025-03-26T04:32:20Z',
          num_transactions: 0,
          proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
          fee_recipient: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
          size: 0,
          block_reward: ['ETHÂ 0'],
        },
        genesis_overview: {
          rollups: 0,
          transactions: 5190575,
          blocks: 1754271,
        },
        latest_blocks: [
          {
            hash: 'BLOCK~GUNsyaAvccldR1WCO-XunDAnwhtsJNayaC0kgp5SHinR',
            height: 1754270,
            proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:32:20Z',
          },
          {
            hash: 'BLOCK~YSmJ4cC7vmIu8DOhJY6tvTePmWglkH_CEvOx0G_MtBJN',
            height: 1754269,
            proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:32:11Z',
          },
          {
            hash: 'BLOCK~Sr_O38TokUZ-VqL6alYpWNAkY8lKb8LM7BFdrfGMN-fq',
            height: 1754268,
            proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:32:03Z',
          },
          {
            hash: 'BLOCK~tryqysIxAZ-R4ORAdPONiQjlrddVtGcANf4dXkTu-9q1',
            height: 1754267,
            proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:31:54Z',
          },
          {
            hash: 'BLOCK~OXA9rE16XdCzaQhxNoyP-4CKgIyZRt8n2zCDY0pV2Cmo',
            height: 1754266,
            proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:31:46Z',
          },
          {
            hash: 'BLOCK~fWvFoNa4oweHhyEWdNQ_1xzfpJAmiZHdlDDabCNrVRAj',
            height: 1754265,
            proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:31:38Z',
          },
          {
            hash: 'BLOCK~PpjiDaUmiU1OBC0t5icHxtY4qNATYB-UHHCsyHLVda5_',
            height: 1754264,
            proposer_id: ['0xb0cfa4e5893107e2995974ef032957752bb526e9'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:31:29Z',
          },
          {
            hash: 'BLOCK~nY0sVuYcfJuXfBg-Z7_yYHXW5O-4g5r-1u0T0PEHGPI0',
            height: 1754263,
            proposer_id: ['0x39f1f69a70eba3e6444a2086ae0e044b87a246af'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:31:21Z',
          },
          {
            hash: 'BLOCK~b9q4xeT4paj-LQtWl0-1mlW2mKcM-fry_C4bKZBBSe9P',
            height: 1754262,
            proposer_id: ['0x39f1f69a70eba3e6444a2086ae0e044b87a246af'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:31:20Z',
          },
          {
            hash: 'BLOCK~PtdVbYEQtCc7RqlzI8p1evMtYfjfxBFUI-h6Rrapce3r',
            height: 1754261,
            proposer_id: ['0x39f1f69a70eba3e6444a2086ae0e044b87a246af'],
            num_transactions: 0,
            size: 0,
            time: '2025-03-26T04:31:17Z',
          },
        ],
        latest_transactions: [
          {
            hash: 'TX~92APsEjTGM6cS9jCAE1V1gEwkoGcYEzijX0eWFtIyzJW',
            rollups: [1380012617],
            height: 1754260,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:31:16Z',
          },
          {
            hash: 'TX~T6B--YgyZUMgOwG3dPSfCdBOS0e7FuaiQaUj3BspwvZl',
            rollups: [1380012617],
            height: 1754259,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:31:15Z',
          },
          {
            hash: 'TX~w0_dmjhF2R8qX_9GZtbmwKVD4jkiHbZ2cEua41LPpIH7',
            rollups: [1380012617],
            height: 1754250,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:30:28Z',
          },
          {
            hash: 'TX~UzMr-gfX1PF43LURPf9t2pV7G9gsXfh7v67P4B9iET7H',
            rollups: [1380012617],
            height: 1754242,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:29:44Z',
          },
          {
            hash: 'TX~K83WsRTN2079MCF88aYiL-2QNqPj3j6YMyvUB14Ld_cH',
            rollups: [1380012617],
            height: 1754237,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:29:21Z',
          },
          {
            hash: 'TX~Kai9BDctXQ_aS-xESogJRQVojmw0aMlKhoSjFnR4fYPv',
            rollups: [1380012617],
            height: 1754213,
            offset: 1,
            num_transactions: 2,
            time: '2025-03-26T04:26:21Z',
          },
          {
            hash: 'TX~0ozCo9PM2QWleY9MTRZjnBzY8jyqFDRrBo7Wtlvoq85B',
            rollups: [1380012617],
            height: 1754213,
            offset: 0,
            num_transactions: 2,
            time: '2025-03-26T04:26:21Z',
          },
          {
            hash: 'TX~NPRxU0j__OT9jetGTj615OydJ2nmpbzFdxGVd7dn0ALM',
            rollups: [1380012617],
            height: 1754191,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:23:41Z',
          },
          {
            hash: 'TX~pyb7DSmUcmDD3U-smPJev4RRrpwK4JLC40MGbA1bJfv4',
            rollups: [1380012617],
            height: 1754172,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:21:19Z',
          },
          {
            hash: 'TX~fw1X-AzMLZ5pLfpYlknNZntfig_U5iFSlCHJN--tum5I',
            rollups: [1380012617],
            height: 1754162,
            offset: 0,
            num_transactions: 1,
            time: '2025-03-26T04:20:20Z',
          },
        ],
        histograms: {
          block_time: [
            null,
            9,
            8,
            8,
            9,
            8,
            9,
            8,
            9,
            9,
            9,
            8,
            9,
            8,
            8,
            9,
            4,
            3,
            3,
            4,
            8,
            5,
            3,
            2,
            2,
            8,
            8,
            9,
            8,
            4,
            2,
            1,
            2,
            8,
            8,
            8,
            9,
            8,
            1,
            1,
            1,
            3,
            1,
            8,
            9,
            8,
            8,
            9,
            8,
            9,
          ],
          block_size: [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5419, 0, 0, 0, 0,
            5412, 0, 0, 0, 0, 0, 0, 0, 5022, 0, 0, 0, 0, 0, 0, 0, 0, 5122, 6079,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          ],
          block_transactions: [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0,
            0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0,
          ],
          block_heights: [
            1754221, 1754222, 1754223, 1754224, 1754225, 1754226, 1754227,
            1754228, 1754229, 1754230, 1754231, 1754232, 1754233, 1754234,
            1754235, 1754236, 1754237, 1754238, 1754239, 1754240, 1754241,
            1754242, 1754243, 1754244, 1754245, 1754246, 1754247, 1754248,
            1754249, 1754250, 1754251, 1754252, 1754253, 1754254, 1754255,
            1754256, 1754257, 1754258, 1754259, 1754260, 1754261, 1754262,
            1754263, 1754264, 1754265, 1754266, 1754267, 1754268, 1754269,
            1754270,
          ],
        },
      },
    };

    const { histograms } = response.explorer_summary;

    const values = Array.from(
      mapIterable(
        filterIterable(
          zipWithIterable(
            dropIterable(histograms.block_time, 1),
            histograms.block_size,
            (time, size) => [time, size] as const,
          ),
          ([, size]) => size > 0,
        ),
        ([time]) => time,
      ),
    );

    // expect(values).deep.equals(
    //   [3, 3, 2, 1, 1],
    //   'does not match expected reduction',
    // );

    const stats = DataStatistics.compute(values);

    expect(stats.nullableMean).to.equal(2, 'mean is incorrect');
  });
});

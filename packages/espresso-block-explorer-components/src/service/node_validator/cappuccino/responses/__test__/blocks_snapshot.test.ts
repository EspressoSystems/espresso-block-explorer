import { describe, it } from 'vitest';
import { cappuccinoBlocksSnapshotCodec } from '../blocks_snapshot';
import { cappuccinoNodeValidatorResponseCodec } from '../node_validator_response_codec';

describe('BlocksSnapshot', () => {
  it('should decode from json', () => {
    const rawString =
      '{"BlocksSnapshot":[{"hash":"BLOCK~zOPNCPEvMrpmaQtOICGTPF-7x2B_x8-Z81fJODkQ6wnx","height":109,"time":"2024-07-16T20:29:03Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~CoCcUur-iBojLEcxLy5MyNw4BiMuOgTs2TVZeq3ngOUp","height":110,"time":"2024-07-16T20:29:06Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~lnhI_4r6m_pIuI2x5GlH9CvvRQdYVoJr1aB7jEcQHKNB","height":111,"time":"2024-07-16T20:29:08Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~7EpTGuppgf6sJ6NVTOMwCOxMyNZMuG10d7oWBBo6mQ51","height":112,"time":"2024-07-16T20:29:10Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~bAgW7-eMpXjy1_lDu9peJeWY_TQyQ0VpKzSb7iP6Q_-7","height":113,"time":"2024-07-16T20:29:12Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~Fql7vGGgjfMYnJ8e7kQtN4VyXh0E9kGzoHIv3opS0RFh","height":114,"time":"2024-07-16T20:29:14Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~SrawCAZZpZBiFukXVcwi3-XpGnV5j9H7roTnRrLh18Lz","height":115,"time":"2024-07-16T20:29:16Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~w4qJphdJdGtkKsLdoqrn5zv-JAXFle6GXn3OTt0piAdd","height":116,"time":"2024-07-16T20:29:18Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~G9-HxcFIIB7Br7aY0sZSdC21rKtYBa9nX3ySOZ9wNfSh","height":117,"time":"2024-07-16T20:29:20Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~U-v5ELU6b6sXRUzXkV9lvqJ9hWSbO05meaULOUvc202g","height":118,"time":"2024-07-16T20:29:22Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~1b05O7l0UfbSl0wbcuZXkQCfJJPmN4APXK0Cpowuuuci","height":119,"time":"2024-07-16T20:29:24Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~Rer5H7M9C4PC4eo4WhSJWiDhRkzSa2W9r5-Do4tgiaR0","height":120,"time":"2024-07-16T20:29:26Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~zFWKb685NWQ8lqzOWcOhi7pET0lVR9oxT4OHCCNcQzzh","height":121,"time":"2024-07-16T20:29:28Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~pTm9nNa0Eqn0Or5gnMGlKt8BuoNpBT3ksVink-QUe3Fu","height":122,"time":"2024-07-16T20:29:30Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~7-seGJsVj1bV5vfDCH83_7NfuN5COlAR1ryas_RHlYDi","height":123,"time":"2024-07-16T20:29:32Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~tqUsuTZFyA2wfEDSjXNXOfTukeowGy8RbZmf98l882ht","height":124,"time":"2024-07-16T20:29:34Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~-kS4S6TTb3-UVqE04ICw8kyAIsSQuHj65_FLHzMIVQiS","height":125,"time":"2024-07-16T20:29:36Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~Pu81QmAA5J4z-RVEx1Z-boMmIIEG2-L8ctv-iHD4HOO3","height":126,"time":"2024-07-16T20:29:38Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~CfmVGQof42PFZ85XEzAPVp2mu1zEJucLBkFPjEGicu3G","height":127,"time":"2024-07-16T20:29:40Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~IGZ6ZzWgBoj-cxG6K5ZGTGXaIGksNYXuCJXy7ePgmv6b","height":128,"time":"2024-07-16T20:29:42Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~bz3-LqavcqwErnImtENBaRIgzYUlmENUc58vttI9upOv","height":129,"time":"2024-07-16T20:29:44Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~yHGM_oLEunqNp8g6kX6J4utasECOfuI-5QH2e_vJwmPy","height":130,"time":"2024-07-16T20:29:46Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~f8eo83KmvmwmYOFOCCS6FrwT7MUdr0nU7NFyzMlWYE59","height":131,"time":"2024-07-16T20:29:48Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~dnWuH4JmyMVuqgwJ7PBnDwpIOOkJkYG3_fNY-8XICm2V","height":132,"time":"2024-07-16T20:29:50Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~eQqkofeU23-gKx-hxJdNV8mBp2SASHpOjwmfSQNQ5E43","height":133,"time":"2024-07-16T20:29:52Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~iJygavJ1s6Y8zgHbOAO64gplAxhLbiCTRGTR8qPjXPxV","height":134,"time":"2024-07-16T20:29:54Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~ABi_3gkR4_MJASkYrFzJqdsYUumqkon0B47GogEwtykQ","height":135,"time":"2024-07-16T20:29:56Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~C2D3hEepdS1YGkzpbZsBKEMadSBNq4ES_uXYP9fI4aTT","height":136,"time":"2024-07-16T20:29:58Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~EJR92w9t_S7HA_2FpttLxJcY6UQ6WLMYxrH4xW_Ivq2F","height":137,"time":"2024-07-16T20:30:01Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~a-gdp3_o5my9qlwfIU4_6lXRicrlvDfz5GXHJiZKgguK","height":138,"time":"2024-07-16T20:30:03Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~ZdjEvjtYLITs-F4iAvMuHkIpBlAEEBZmiHnaqtE5FLYQ","height":139,"time":"2024-07-16T20:30:05Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~PlfZ77ROtWKqFAAdp8JHNG8x3trLIcN2a3wGjV3Fed0I","height":140,"time":"2024-07-16T20:30:07Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~13IMP5uWLqthVHAc8IoG5MyAlikKonB5LlHIGEcsxjKO","height":141,"time":"2024-07-16T20:30:09Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~fg3I_06gSE7g36hsOgC1RB-8kyKsx2elpChr6rtFEN1t","height":142,"time":"2024-07-16T20:30:11Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~PR27MPzTdB8vtVPDzELfVxvwNsWKkBNt8McLyPb6woPs","height":143,"time":"2024-07-16T20:30:13Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~GPr6IY8pOr0ektVxAiqitS64n0lXmRkJJ7Gj9eKU7tVU","height":144,"time":"2024-07-16T20:30:15Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~c6bWo9-bUHrABg8_VriMU0d-9fD-_vauVFxOlMG1dkKV","height":145,"time":"2024-07-16T20:30:17Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~QrJmTPE2tZ_kxoLH9p_-_boCH5P05z8Q92HksP1ZYYJI","height":146,"time":"2024-07-16T20:30:19Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~XTap9nGk-BSQeIxyyccr0oREIV16OETn6ANPxVyDy4p4","height":147,"time":"2024-07-16T20:30:21Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~DJwktDkkuCCD2eh5zPzdlaPNc9iZvUxsz9gFsHKgNLlO","height":148,"time":"2024-07-16T20:30:23Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~8cz_iAe4LwEwqwPfglOMbJiBhYNZKW_c8a_idmuopMhV","height":149,"time":"2024-07-16T20:30:25Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~RtwF4SFEozO2AWcczCmFwBC3wpzcbT7WLBiPLrLQKLxa","height":150,"time":"2024-07-16T20:30:27Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~vODhkYG5rbFi4319eT3xXrjYSyBe9ZJCJu9kDXxYv9uX","height":151,"time":"2024-07-16T20:30:29Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~X7BxrPqyY6JmLuR37NZB_EPwFjv4-pMth7ikxRItLHWK","height":152,"time":"2024-07-16T20:30:31Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~SHlciicuvDeuxEv0uBpNViP2L4gEXrPoP0FKKd4b8Bs4","height":153,"time":"2024-07-16T20:30:33Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~pt3JuZNoBXc7vklbk_8gDtKXkfBVwhoibji5aSB0BozK","height":154,"time":"2024-07-16T20:30:35Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~avYuCZfuCDf24XJEJYF-hzqHQZHIhk_O6VP-5RldTNMr","height":155,"time":"2024-07-16T20:30:37Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~HGsztt4TjNrHxghDuci4leshyUMplgz8_2EzRM33MrLO","height":156,"time":"2024-07-16T20:30:39Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~wiIshHAlSpqTE0QrTJ75_gEOp888HO1lcTIN3RGmX4Gt","height":157,"time":"2024-07-16T20:30:41Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]},{"hash":"BLOCK~g1IjARQ-8yUyl4xFcC1AumEpBmrCUjvhd_VgnMFmclsG","height":158,"time":"2024-07-16T20:30:43Z","num_transactions":0,"proposer_id":"0xb0cfa4e5893107e2995974ef032957752bb526e9","fee_recipient":"0xb0cfa4e5893107e2995974ef032957752bb526e9","size":0,"block_reward":["ETH 0"]}]}';

    const response = cappuccinoBlocksSnapshotCodec.decode(
      JSON.parse(rawString),
    );

    expect(response.blocks.length).toBe(50);
    const blockIterator = response.blocks[Symbol.iterator]();

    {
      // Block 0
      const next = blockIterator.next();
      if (next.done) {
        throw new Error('Expected block');
      }

      const block0 = next.value;

      expect(block0.height).toBe(109);
      expect(block0.time.toISOString()).toBe('2024-07-16T20:29:03.000Z');
      expect(block0.numTransactions).toBe(0);
      expect(block0.proposerID).not.toBe(null);
      expect(block0.size).not.toBe(null);
    }

    for (let i = 1; i < 50; i++) {
      const next = blockIterator.next();
      if (next.done) {
        throw new Error('Expected block');
      }

      const block = next.value;

      expect(block.height).toBe(109 + i);
      expect(block.time).not.toBe(null);
      expect(block.numTransactions).not.toBe(null);
      expect(block.proposerID).not.toBe(null);
      expect(block.size).not.toBe(null);
    }

    expect(blockIterator.next().done).toBe(true);

    expect(response.toJSON()).toStrictEqual(
      cappuccinoBlocksSnapshotCodec.encode(response),
    );

    expect(
      cappuccinoNodeValidatorResponseCodec.decode(JSON.parse(rawString)),
    ).toStrictEqual(
      cappuccinoBlocksSnapshotCodec.decode(JSON.parse(rawString)),
    );

    expect(cappuccinoNodeValidatorResponseCodec.encode(response)).toStrictEqual(
      cappuccinoBlocksSnapshotCodec.encode(response),
    );
  });
});
